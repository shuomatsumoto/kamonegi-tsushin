---
type Notice = {
  date?: string;
  title: string;
  href?: string;
};

const { notices, limit, title = "お知らせ" } = Astro.props as {
  notices: Notice[];
  limit?: number;
  title?: string;
  recentDays?: number;
};

const recentDays =
  typeof Astro.props.recentDays === "number" ? Astro.props.recentDays : undefined;

function tokyoTodayYMD() {
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: "Asia/Tokyo",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).formatToParts(new Date());
  const y = parts.find((p) => p.type === "year")?.value ?? "1970";
  const m = parts.find((p) => p.type === "month")?.value ?? "01";
  const d = parts.find((p) => p.type === "day")?.value ?? "01";
  return `${y}-${m}-${d}`;
}

function toDayNumber(ymd: string) {
  if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return null;
  const [y, m, d] = ymd.split("-").map(Number);
  return Math.floor(Date.UTC(y, m - 1, d) / 86400000);
}

const todayDay = toDayNumber(tokyoTodayYMD());
const filteredByRecent =
  typeof recentDays === "number" && todayDay !== null
    ? notices.filter((n) => {
        const dateLabel = (n.date ?? "").trim();
        const nDay = toDayNumber(dateLabel);
        if (nDay === null) return false;
        const diff = todayDay - nDay;
        return diff >= 0 && diff < recentDays;
      })
    : notices;

const shown = typeof limit === "number" ? filteredByRecent.slice(0, limit) : filteredByRecent;
const grouped = shown.reduce((acc, n) => {
  const dateLabel = (n.date ?? "").trim() || "（未定）";
  const last = acc[acc.length - 1];
  if (last && last.date === dateLabel) {
    last.items.push(n);
    return acc;
  }
  acc.push({ date: dateLabel, items: [n] });
  return acc;
}, [] as Array<{ date: string; items: Notice[] }>);
---
<section class="plainSection">
  <div class="sectionHead">
    <h2>{title}</h2>
  </div>

  <ul class="postList">
    {grouped.map((g) => (
      <li>
        <div class="noticeRow">
          <span class="date">{g.date}</span>
          <ul class="itemsList">
            {g.items.map((n) => (
              <li class="noticeItem">
                <span class="bullet" aria-hidden="true">・</span>
                {n.href ? (
                  <a class="title link" href={n.href}>{n.title}</a>
                ) : (
                  <span class="title">{n.title}</span>
                )}
              </li>
            ))}
          </ul>
        </div>
      </li>
    ))}
  </ul>
</section>

<style>
  .plainSection { padding: 0; margin: 0; }
  .sectionHead { margin: 0 0 8px; }
  .sectionHead h2 {
    margin: 0;
    font-size: 0.92rem;
    line-height: 1.15;
    font-weight: 400;
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .postList { list-style: none; padding: 0; margin: 0; }

  .noticeRow {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px;
    align-items: start;
    padding: 5px 0;
    border-bottom: 1px dotted var(--line);
    color: var(--muted);
  }

  .date {
    font-size: 0.76em;
    opacity: 0.92;
    white-space: nowrap;
  }

  .itemsList {
    min-width: 0;
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 2px;
    font-size: 0.82em;
    font-weight: 400;
    opacity: 0.96;
    line-height: 1.45;
  }

  .noticeItem {
    display: flex;
    align-items: baseline;
  }

  .bullet {
    margin-right: 0.1em;
  }

  .title { color: inherit; }

  .link {
    text-decoration: none;
    color: inherit;
  }

  .link:hover { opacity: 0.86; }

  @media (max-width: 640px) {
    .noticeRow {
      grid-template-columns: 1fr;
      gap: 2px;
    }

    .date { white-space: normal; }
  }
</style>
