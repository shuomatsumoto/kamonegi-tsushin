---
import type { CollectionEntry } from "astro:content";

const { posts, limit, title = "記事" } = Astro.props as {
  posts: CollectionEntry<"posts">[];
  limit?: number;
  title?: string;
};

const shown = typeof limit === "number" ? posts.slice(0, limit) : posts;

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

function thumbSrc(raw?: string) {
  if (!raw) return null;
  if (raw.startsWith("http://") || raw.startsWith("https://")) return raw;
  if (raw.startsWith("/")) return `${BASE}${raw.slice(1)}`;
  return `${BASE}${raw.replace(/^\/+/, "")}`;
}

---
<section class="plainSection">
  {title ? (
    <div class="sectionHead">
      <h2>{title}</h2>
    </div>
  ) : null}

  <ul class="postList">
    {shown.map((p) => {
      const summary = p.data.summary ?? "";
      const t = thumbSrc((p.data as any).thumbnail as string | undefined);
      const tags = p.data.tags ?? [];

      return (
        <li>
          <a class="postCard" data-category={p.data.category} href={`${BASE}posts/${p.slug}`}>
            {t ? <img class="thumb" src={t} alt="" loading="lazy" /> : null}
            <strong class="title">{p.data.title}</strong>
            {summary ? <p class="summary">{summary}</p> : null}
            <div class="metaStack">
              {p.data.series ? <p class="seriesLine">{p.data.series}</p> : null}
              <div class="postMeta">
                <span class="category">{p.data.category}</span>
                {tags.length ? <span class="tags">#{tags.join(" #")}</span> : null}
              </div>
            </div>
          </a>
        </li>
      );
    })}
  </ul>
</section>

<style>
  .plainSection { padding: 0; margin: 0; }
  .sectionHead { margin: 0 0 8px; }
  .sectionHead h2 {
    margin: 0;
    font-size: 0.92rem;
    line-height: 1.15;
    font-weight: 400;
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .postList {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .postCard {
    display: block;
    padding: 12px 0 13px;
    border-bottom: 1px dotted var(--line);
    text-decoration: none;
    color: var(--ink);
  }

  .thumb {
    display: block;
    width: 100%;
    aspect-ratio: 8 / 5;
    height: auto;
    object-fit: cover;
    margin: 0 0 8px;
    border: 1px solid rgba(64, 54, 40, 0.12);
  }

  .postCard:hover {
    opacity: 0.9;
  }

  .postMeta {
    display: flex;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: var(--space-2);
    align-items: baseline;
    font-size: var(--fs-list-meta);
    color: var(--muted);
    font-style: normal;
  }

  .title {
    display: block;
    font-size: var(--fs-list-title);
    line-height: 1.3;
    color: var(--ink);
    font-weight: 400;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .summary {
    margin: var(--space-2) 0 0;
    font-size: var(--fs-list-summary);
    line-height: 1.5;
    color: var(--muted);
    opacity: 0.84;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .seriesLine {
    margin: 0;
    font-size: var(--fs-list-summary);
    line-height: 1.2;
    color: #4d5f42;
    font-weight: 700;
  }

  .metaStack {
    margin-top: var(--space-5) !important;
    padding-top: 0;
    display: grid;
    gap: 0;
  }

  .summary + .metaStack,
  .title + .metaStack {
    margin-top: var(--space-5) !important;
  }

  .category {
    display: inline-flex;
    gap: var(--space-1);
    align-items: center;
    color: var(--muted);
  }

  .tags {
    color: var(--muted);
    opacity: 0.66;
  }

  @media (max-width: 640px) {
    .title { font-size: 1.08rem; }
    .summary { font-size: 0.82rem; }
  }
</style>
