---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

function isNoteLike(data: { kind?: string }) {
  return data.kind === "note";
}

const postsAll = await getCollection(
  "posts",
  ({ data }) => {
    if (data.draft) return false;
    return !isNoteLike(data);
  }
);

// 最新順：date 降順 → 同日内は slug で安定化
const posts = [...postsAll].sort((a, b) => {
  if (a.data.date !== b.data.date) return a.data.date < b.data.date ? 1 : -1;
  return a.slug < b.slug ? 1 : -1;
});

const categories = Array.from(
  new Set(posts.map((p) => (p.data.category ?? "").trim()).filter(Boolean))
)
  .sort((a, b) => a.localeCompare(b, "ja"));

function safeTags(tags: unknown): string[] {
  return Array.isArray(tags) ? tags.filter((t) => typeof t === "string") : [];
}

function thumbSrc(raw?: string) {
  if (!raw) return null;
  if (raw.startsWith("http://") || raw.startsWith("https://")) return raw;
  if (raw.startsWith("/")) return `${BASE}${raw.slice(1)}`;
  return `${BASE}${raw.replace(/^\/+/, "")}`;
}

const data = posts.map((p) => ({
  slug: p.slug,
  title: p.data.title,
  summary: p.data.summary ?? "",
  date: p.data.date,
  series: p.data.series ?? "",
  category: (p.data.category ?? "").trim(),
  thumb: thumbSrc(p.data.thumbnail),
  tags: safeTags(p.data.tags),
}));
---
<BaseLayout title="記事一覧 | かもねぎ通信">
  <section class="catalog">
    <header class="catalogHead">
      <h2 class="h2" style="margin:0;">記事一覧</h2>
      <div class="catalogMeta">
        <div id="qHint" class="small qHint" hidden></div>
        <div class="small count"><span id="count">{data.length} 件</span></div>
      </div>
    </header>

    <nav class="indexLinks" aria-label="一覧ページ">
      <a href={`${BASE}translation`} class="indexLink">研究・翻訳</a>
      <a href={`${BASE}novel`} class="indexLink">小説</a>
      <a href={`${BASE}category`} class="indexLink">カテゴリ</a>
      <a href={`${BASE}series`} class="indexLink">連載</a>
      <a href={`${BASE}tags`} class="indexLink">タグ</a>
    </nav>

    <div class="tools" aria-label="絞り込みと並び替え">
      <select id="cat" class="sel" aria-label="カテゴリで絞り込み">
        <option value="">すべてのカテゴリ</option>
        {categories.map((c) => (
          <option value={c}>{c}</option>
        ))}
      </select>

      <select id="sort" class="sel" aria-label="並び順">
        <option value="new">新しい順</option>
        <option value="old">古い順</option>
      </select>
    </div>

    {/* ✅ まず Astro 側で必ず表示（JSが落ちても見える） */}
    <ul id="list" class="postGrid">
      {data.map((it) => (
        <li
          class="li cardItem"
          data-title={it.title}
          data-category={it.category}
          data-tags={it.tags.join(" ")}
          data-date={it.date}
          data-slug={it.slug}
        >
          <a class="postCard" data-category={it.category} href={`${BASE}posts/${it.slug}`}>
            {it.thumb ? <img class="thumb post-thumb-wide" src={it.thumb} alt="" loading="lazy" /> : null}
            <div class="cardBody">
              <strong class="title post-title-2line">{it.title}</strong>
              <p class="date mono">{it.date}</p>
              {it.summary ? <p class="summary post-summary-3line">{it.summary}</p> : null}
              <div class="metaStack">
                {it.series ? <p class="seriesLine post-series-accent">〈{it.series}〉</p> : null}
                <p class="metaInfo">
                  {it.category ? <span class="category">{it.category}</span> : null}
                  {it.tags.length ? <span class="tags">#{it.tags.join(" #")}</span> : null}
                </p>
              </div>
            </div>
          </a>
        </li>
      ))}
    </ul>
  </section>

  {/* ✅ JS は “絞り込みだけ” 担当 */}
  <script is:inline>
    const elCat = document.getElementById("cat");
    const elSort = document.getElementById("sort");
    const elCount = document.getElementById("count");
    const list = document.getElementById("list");
    const qHint = document.getElementById("qHint");
    const urlQ = new URLSearchParams(window.location.search).get("q") || "";

    function norm(s){ return (s || "").toString().trim().toLowerCase(); }

    function apply(){
      const qRaw = norm(urlQ);
      const q = qRaw.startsWith("#") ? qRaw.slice(1) : qRaw;
      const cat = elCat.value;
      const sort = elSort.value;

      const items = Array.from(list.querySelectorAll("li.li"));

      // 絞り込み
      let visible = [];
      for (const li of items) {
        const title = (li.dataset.title || "").toLowerCase();
        const category = (li.dataset.category || "");
        const tags = (li.dataset.tags || "").toLowerCase();

        if (cat && category !== cat) { li.style.display = "none"; continue; }
        if (q && !(title.includes(q) || tags.includes(q) || category.toLowerCase().includes(q))) {
          li.style.display = "none"; continue;
        }

        li.style.display = "";
        visible.push(li);
      }

      // 並び替え（date→slug）
      visible.sort((a,b)=>{
        const da = a.dataset.date || "";
        const db = b.dataset.date || "";
        if (da !== db) return sort === "new" ? (da < db ? 1 : -1) : (da > db ? 1 : -1);
        const sa = a.dataset.slug || "";
        const sb = b.dataset.slug || "";
        return sort === "new" ? (sa < sb ? 1 : -1) : (sa > sb ? 1 : -1);
      });

      // DOM並べ替え
      for (const li of visible) list.appendChild(li);

      elCount.textContent = `${visible.length} 件`;
    }

    if (qHint && urlQ.trim()) {
      qHint.hidden = false;
      qHint.textContent = `検索: 「${urlQ.trim()}」`;
    }

    elCat.addEventListener("change", apply);
    elSort.addEventListener("change", apply);
    apply();
  </script>

  <style>
    .catalog {
      width: min(100%, 940px);
      margin-inline: auto;
      display: grid;
      gap: 14px;
    }

    .catalogHead {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
      padding-top: 4px;
    }

    .catalogMeta {
      display: flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tools {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      padding-bottom: 10px;
      border-bottom: 1px dotted var(--line);
    }

    .indexLinks {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      margin-top: -2px;
    }

    .indexLink {
      text-decoration: none;
      color: var(--muted);
      font-size: 0.82rem;
      line-height: 1.2;
      padding: 2px 0;
    }

    .indexLink:hover {
      opacity: 0.78;
    }

    .qHint {
      color: var(--muted);
      font-size: 0.8rem;
      opacity: 0.82;
    }

    .count {
      font-size: 0.8rem;
      color: var(--muted);
      opacity: 0.82;
    }

    .sel {
      min-width: 130px;
      height: 30px;
      padding: 0 9px;
      border: 1px solid rgba(64, 54, 40, 0.2);
      border-radius: 0;
      background: #fff;
      color: var(--ink);
      font-family: inherit;
      font-size: 0.8rem;
    }

    .postGrid {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .cardItem {
      min-width: 0;
    }

    .postCard {
      display: grid;
      grid-template-rows: auto 1fr;
      text-decoration: none;
      color: var(--ink);
      border: 1px solid rgba(64, 54, 40, 0.14);
      background: #fff;
      height: 100%;
      transition: border-color 0.16s ease, background 0.16s ease;
    }

    .postCard:hover {
      border-color: rgba(64, 54, 40, 0.3);
      background: #fdfcf9;
    }

    .thumb {
      border-bottom: 1px solid rgba(64, 54, 40, 0.12);
    }

    .cardBody {
      min-width: 0;
      display: grid;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3) var(--space-3);
    }

    .category {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      min-width: 0;
    }

    .date {
      margin: 0;
      font-size: 0.74rem;
      color: var(--muted);
      opacity: 0.78;
      white-space: nowrap;
    }

    .title {
      display: block;
      font-size: var(--fs-list-title);
      line-height: 1.34;
      color: var(--ink);
      font-weight: 400;
    }

    .summary {
      margin: 0;
      font-size: var(--fs-list-summary);
      line-height: 1.5;
      color: var(--muted);
      opacity: 0.74;
    }

    .seriesLine {
      margin: 0;
      font-size: var(--fs-list-summary);
      line-height: 1.2;
    }

    .metaStack {
      margin-top: var(--space-5) !important;
      padding-top: 0;
      display: grid;
      gap: 0;
    }

    .summary + .metaStack,
    .title + .metaStack {
      margin-top: var(--space-5) !important;
    }

    .metaInfo {
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: baseline;
      font-size: var(--fs-list-meta);
      color: var(--muted);
    }

    .tags {
      margin: 0;
      font-size: 0.78rem;
      color: var(--muted);
      opacity: 0.62;
      line-height: 1.4;
    }

    @media (max-width: 900px) {
      .postGrid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .catalogHead {
        align-items: flex-start;
      }

      .tools {
        gap: 6px;
      }

      .sel {
        width: 100%;
      }

      .postGrid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
