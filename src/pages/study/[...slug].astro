---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { createHash } from "node:crypto";
import LockGate from "../../components/LockGate.astro";

export async function getStaticPaths() {
  const translationItems = await getCollection("translation", ({ data }) => !data.draft);
  const researchItems = await getCollection("research", ({ data }) => !data.draft);
  const seen = new Set<string>();
  const merged = [...translationItems, ...researchItems].filter((item) => {
    if (seen.has(item.slug)) return false;
    seen.add(item.slug);
    return true;
  });
  return merged.map((item) => ({ params: { slug: item.slug }, props: { item } }));
}

const { item } = Astro.props;
const { Content } = await item.render();
const lockHash = item.data.lockPasscode
  ? createHash("sha256").update(item.data.lockPasscode).digest("hex")
  : "";
const storageKey = `study/${item.slug}`;
const hasInfoCard = Boolean(
  item.data.translationAuthor ||
  item.data.originalAuthor ||
  item.data.sourceTitle ||
  item.data.sourceUrl ||
  item.data.sourceNote
);
---
<BaseLayout title={`${item.data.title} | 研究・翻訳 | かもねぎ通信`}>
  <article class="plainArticle">
    <div class="articleMeta">
      <span class="small mono">{item.data.date}</span>
      {item.data.tags?.length ? <span class="small tags">#{item.data.tags.join(" #")}</span> : null}
    </div>
    <h1 class="h1">{item.data.title}</h1>
    {item.data.summary ? <p class="summaryLead">{item.data.summary}</p> : null}
    {hasInfoCard ? (
      <section class="translationCard" aria-label="翻訳情報">
        {item.data.translationAuthor ? (
          <p class="cardRow">
            <span class="cardLabel">訳</span>
            <span>{item.data.translationAuthor}</span>
          </p>
        ) : null}
        {item.data.originalAuthor ? (
          <p class="cardRow">
            <span class="cardLabel">著者</span>
            <span>{item.data.originalAuthor}</span>
          </p>
        ) : null}
        {item.data.sourceTitle ? (
          <p class="cardRow">
            <span class="cardLabel">出典</span>
            <span>{item.data.sourceTitle}</span>
          </p>
        ) : null}
        {item.data.sourceUrl ? (
          <p class="cardRow">
            <span class="cardLabel">URL</span>
            <a href={item.data.sourceUrl} target="_blank" rel="noopener noreferrer">
              {item.data.sourceUrl}
            </a>
          </p>
        ) : null}
        {item.data.sourceNote ? (
          <p class="cardRow">
            <span class="cardLabel">注記</span>
            <span>{item.data.sourceNote}</span>
          </p>
        ) : null}
      </section>
    ) : null}
    <LockGate
      locked={item.data.locked}
      lockHash={lockHash}
      storageKey={storageKey}
    >
      <div class="prose">
        <Content />
      </div>
    </LockGate>
  </article>
</BaseLayout>

<style>
  .plainArticle {
    padding: 0;
    margin: 0;
    padding-top: 15px;
    max-width: 760px;
    margin-inline: auto;
  }

  .articleMeta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: baseline;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .tags { opacity: 0.76; }

  .plainArticle .h1 {
    font-size: clamp(1.45rem, 2.7vw, 1.82rem);
    line-height: 1.38;
    margin: 0 0 8px;
  }

  .summaryLead {
    margin: 0 0 14px;
    color: var(--muted);
    opacity: 0.86;
    font-size: 0.92rem;
    line-height: 1.6;
  }

  .translationCard {
    margin: 0 0 18px;
    padding: 14px 16px;
    border: 1px solid rgba(64, 54, 40, 0.38);
    outline: 1px solid rgba(64, 54, 40, 0.14);
    outline-offset: -4px;
    border-radius: 0;
    background: #faf8f2;
    display: grid;
    gap: 7px;
  }

  .cardRow {
    margin: 0;
    display: grid;
    grid-template-columns: 48px 1fr;
    gap: 8px;
    align-items: baseline;
    font-size: 0.9rem;
    line-height: 1.55;
  }

  .cardLabel {
    color: var(--muted);
    font-size: 0.78rem;
    letter-spacing: 0.04em;
  }

  .translationCard a {
    color: var(--ink);
    text-decoration: underline;
    word-break: break-all;
  }

  .prose :global(p) {
    margin: 0 0 1.05em;
    font-size: 1rem;
  }

  .prose :global(h2) {
    margin: 1.8em 0 0.7em;
    font-size: 1.18rem;
    font-weight: 500;
  }

  .prose :global(h3) {
    margin: 1.5em 0 0.6em;
    font-size: 1.02rem;
    font-weight: 400;
    color: var(--muted);
    opacity: 0.9;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 1.2em 0;
    table-layout: fixed;
  }

  .prose :global(th),
  .prose :global(td) {
    position: relative;
    vertical-align: top;
    padding: 0.45em 0.9em;
    font-size: 0.96rem;
    line-height: 1.7;
    font-weight: 400;
    text-align: left;
  }

  .prose :global(th) {
    color: var(--muted);
    font-size: 0.82rem;
    border-bottom: 1px solid var(--line);
  }

  .prose :global(td) {
    border-bottom: 1px dotted rgba(64, 54, 40, 0.16);
  }

  .prose :global(th:nth-child(2)),
  .prose :global(td:nth-child(2)) {
    border-left: 1px solid rgba(64, 54, 40, 0.22);
    padding-left: 1.2em;
  }

  .prose :global(th:nth-child(2)::before),
  .prose :global(td:nth-child(2)::before) {
    content: "｜";
    position: absolute;
    left: 0;
    top: 50%;
    transform: translate(-50%, -50%);
    color: var(--muted);
    opacity: 0.65;
    font-size: 0.86em;
    line-height: 1;
    background: var(--paper);
    padding: 0 0.08em;
  }

  @media (max-width: 720px) {
    .prose :global(table),
    .prose :global(thead),
    .prose :global(tbody),
    .prose :global(tr),
    .prose :global(th),
    .prose :global(td) {
      display: block;
      width: 100%;
    }

    .prose :global(tr) {
      padding: 0.5em 0 0.7em;
      border-bottom: 1px dotted rgba(64, 54, 40, 0.18);
    }

    .prose :global(th) {
      border-bottom: 0;
      padding-bottom: 0.2em;
    }

    .prose :global(td) {
      border-bottom: 0;
      padding-top: 0.15em;
      padding-bottom: 0.15em;
    }

    .prose :global(th:nth-child(2)),
    .prose :global(td:nth-child(2)) {
      border-left: 0;
      padding-left: 0.9em;
    }

    .prose :global(th:nth-child(2)::before),
    .prose :global(td:nth-child(2)::before) {
      left: 0;
      transform: translate(0, -50%);
      background: transparent;
    }
  }
</style>
