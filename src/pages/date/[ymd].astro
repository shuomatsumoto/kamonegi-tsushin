---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { toYMD } from "../../components/category";
import news from "../../data/news.json";
import memorials from "../../data/memorials.json";

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  const postDates = posts.map((p) => p.data.date);

  const now = new Date();
  const dates = new Set<string>();

  // Past/Future navigation support range
  const startYear = now.getFullYear() - 10;
  const endYear = now.getFullYear() + 10;

  const cursor = new Date(startYear, 0, 1);
  const end = new Date(endYear, 11, 31);
  while (cursor <= end) {
    const y = cursor.getFullYear();
    const m = String(cursor.getMonth() + 1).padStart(2, "0");
    const d = String(cursor.getDate()).padStart(2, "0");
    dates.add(`${y}-${m}-${d}`);
    cursor.setDate(cursor.getDate() + 1);
  }

  // Keep any out-of-range content dates routable too.
  for (const d of postDates) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
      dates.add(d);
    }
  }

  return Array.from(dates).sort().map((ymd) => ({ params: { ymd } }));
}

const { ymd } = Astro.params as { ymd: string };

// 記事
const postsAll = await getCollection(
  "posts",
  ({ data }) => !data.draft && data.date === ymd
);

const newsItems = news.filter((n) => (n.date ?? "").trim() === ymd);
const mmdd = ymd.slice(5, 10);
const memorialItems = memorials.filter((m) => m.date === ymd || m.date === mmdd);
---
<BaseLayout title={`${ymd} | かもねぎ通信`}>
  <section class="plainSection">
    <div class="sectionHead">
      <h2 class="h2" style="margin:0;">{ymd}</h2>
    </div>

    <ul class="postList">
      {/* 記事 */}
      {postsAll.map((p) => {
        return (
          <li>
            <a class="postRow" href={`${BASE}posts/${p.slug}`}>
              <span class="left">
                {p.data.category ? <span class="category">{p.data.category}</span> : null}
                {p.data.category ? <span class="sep">｜</span> : null}
                <strong class="title">{p.data.title}</strong>
              </span>

              <span class="right">
                <span class="date">{toYMD(p.data.date)}</span>
                {p.data.tags?.length && (
                  <span class="tags">#{p.data.tags.join(" #")}</span>
                )}
              </span>
            </a>
          </li>
        );
      })}

    </ul>

    {!postsAll.length && !newsItems.length && !memorialItems.length && (
      <div class="small">この日には記事がありません。</div>
    )}

    {(newsItems.length > 0 || memorialItems.length > 0) && (
      <div class="metaBlock">
        {memorialItems.length > 0 && (
          <section class="metaSection isMemorial">
            <h3>記念日</h3>
            <ul class="metaList">
              {memorialItems.map((m) => (
                <li>
                  <span aria-hidden="true">・</span>
                  <span>{m.title}</span>
                </li>
              ))}
            </ul>
          </section>
        )}

        {newsItems.length > 0 && (
          <section class="metaSection">
            <h3>ニュース</h3>
            <ul class="metaList">
              {newsItems.map((n) => (
                <li>
                  <span aria-hidden="true">・</span>
                  {n.href ? (
                    <a href={n.href}>{n.title}</a>
                  ) : (
                    <span>{n.title}</span>
                  )}
                </li>
              ))}
            </ul>
          </section>
        )}
      </div>
    )}
  </section>

  <style>
    .plainSection {
      padding: 0;
      margin: 0;
    }

    .sectionHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 8px;
    }

    .postList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .postRow {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px dotted var(--line);
      text-decoration: none;
      color: var(--ink);
    }

    .left {
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .right {
      display: flex;
      gap: 10px;
      align-items: baseline;
      font-size: 0.85em;
      color: var(--muted);
      white-space: nowrap;
    }

    .category {
      font-size: 0.85em;
      color: var(--muted);
    }

    .sep {
      color: var(--muted);
    }

    .tags {
      color: var(--muted);
    }

    .metaBlock {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .metaSection h3 {
      margin: 0 0 6px;
      font-size: 0.84rem;
      color: var(--muted);
      font-weight: 500;
      letter-spacing: 0.04em;
    }

    .metaSection {
      border: 1px solid rgba(64, 54, 40, 0.14);
      border-radius: 0;
      background: #fff;
      padding: 10px 12px;
    }

    .metaSection.isMemorial {
      border-color: rgba(244, 167, 185, 0.7);
      background: rgba(244, 167, 185, 0.08);
    }

    .metaSection.isMemorial h3,
    .metaSection.isMemorial .metaList {
      color: #c57a92;
    }

    .metaList {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 2px;
      color: var(--muted);
      font-size: 0.9em;
    }

    .metaList li {
      display: flex;
      gap: 0.15em;
      align-items: baseline;
    }

    .metaList a {
      color: inherit;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .postRow {
        flex-direction: column;
        gap: 4px;
      }
      .right {
        white-space: normal;
      }
    }
  </style>
</BaseLayout>
