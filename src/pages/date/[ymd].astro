---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { toYMD } from "../../components/category";

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  const postDates = posts.map((p) => p.data.date);

  // Build month set from existing content plus current month,
  // then generate every day in those months so "empty days" are routable.
  const monthSet = new Set<string>();
  for (const d of postDates) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) monthSet.add(d.slice(0, 7));
  }

  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  monthSet.add(currentMonth);

  const dates: string[] = [];
  for (const ym of monthSet) {
    const y = Number(ym.slice(0, 4));
    const m = Number(ym.slice(5, 7));
    if (!Number.isFinite(y) || !Number.isFinite(m)) continue;
    const lastDay = new Date(y, m, 0).getDate();
    for (let day = 1; day <= lastDay; day++) {
      dates.push(`${ym}-${String(day).padStart(2, "0")}`);
    }
  }

  return dates.sort().map((ymd) => ({ params: { ymd } }));
}

const { ymd } = Astro.params as { ymd: string };

// 記事
const postsAll = await getCollection(
  "posts",
  ({ data }) => !data.draft && data.date === ymd
);
---
<BaseLayout title={`${ymd} | かもねぎ通信`}>
  <section class="plainSection">
    <div class="sectionHead">
      <h2 class="h2" style="margin:0;">{ymd}</h2>
    </div>

    <ul class="postList">
      {/* 記事 */}
      {postsAll.map((p) => {
        return (
          <li>
            <a class="postRow" href={`${BASE}posts/${p.slug}`}>
              <span class="left">
                {p.data.category ? <span class="category">{p.data.category}</span> : null}
                {p.data.category ? <span class="sep">｜</span> : null}
                <strong class="title">{p.data.title}</strong>
              </span>

              <span class="right">
                <span class="date">{toYMD(p.data.date)}</span>
                {p.data.tags?.length && (
                  <span class="tags">#{p.data.tags.join(" #")}</span>
                )}
              </span>
            </a>
          </li>
        );
      })}

    </ul>

    {!postsAll.length && (
      <div class="small">この日には記事がありません。</div>
    )}
  </section>

  <style>
    .plainSection {
      padding: 0;
      margin: 0;
    }

    .sectionHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 8px;
    }

    .postList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .postRow {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px dotted var(--line);
      text-decoration: none;
      color: var(--ink);
    }

    .left {
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .right {
      display: flex;
      gap: 10px;
      align-items: baseline;
      font-size: 0.85em;
      color: var(--muted);
      white-space: nowrap;
    }

    .category {
      font-size: 0.85em;
      color: var(--muted);
    }

    .sep {
      color: var(--muted);
    }

    .tags {
      color: var(--muted);
    }

    @media (max-width: 640px) {
      .postRow {
        flex-direction: column;
        gap: 4px;
      }
      .right {
        white-space: normal;
      }
    }
  </style>
</BaseLayout>
