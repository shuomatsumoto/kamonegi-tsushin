---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import plans from "../../data/plans.json";
import { categoryMeta, toYMD } from "../../components/category";

type Plan = {
  date: string;
  title: string;
  category: "雑記" | "分析" | "創作" | "紹介";
  status?: string;
};

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  const planDates = (plans as Plan[]).map((p) => p.date);
  const postDates = posts.map((p) => p.data.date);
  const dates = Array.from(new Set([...postDates, ...planDates]));
  return dates.map((ymd) => ({ params: { ymd } }));
}

const { ymd } = Astro.params as { ymd: string };

// 記事
const postsAll = await getCollection(
  "posts",
  ({ data }) => !data.draft && data.date === ymd
);

// 予定
const dayPlans = (plans as Plan[]).filter((p) => p.date === ymd);
---
<BaseLayout title={`${ymd} | かもねぎ通信`}>
  <section class="plainSection">
    <div class="sectionHead">
      <h2 class="h2" style="margin:0;">{ymd}</h2>
    </div>

    <ul class="postList">
      {/* 記事 */}
      {postsAll.map((p) => {
        const meta = categoryMeta[p.data.category];
        return (
          <li>
            <a class="postRow" href={`${BASE}posts/${p.slug}`}>
              <span class="left">
                <span class="icon" aria-hidden="true">{meta.icon}</span>
                <span class="category">{p.data.category}</span>
                <span class="sep">｜</span>
                <strong class="title">{p.data.title}</strong>
              </span>

              <span class="right">
                <span class="date">{toYMD(p.data.date)}</span>
                {p.data.tags?.length && (
                  <span class="tags">#{p.data.tags.join(" #")}</span>
                )}
              </span>
            </a>
          </li>
        );
      })}

      {/* 予定 */}
      {dayPlans.map((p) => {
        const meta = categoryMeta[p.category];
        return (
          <li>
            <a class="postRow" href={`${BASE}date/${p.date}`}>
              <span class="left">
                <span class="icon" aria-hidden="true">{meta.icon}</span>
                <span class="category">{p.category}</span>
                <span class="sep">｜</span>
                <strong class="title">
                  {p.title}
                  <span class="planMark">（予定）</span>
                </strong>
              </span>

              <span class="right">
                <span class="date">{toYMD(p.date)}</span>
              </span>
            </a>
          </li>
        );
      })}
    </ul>

    {!postsAll.length && !dayPlans.length && (
      <div class="small">この日には記事も予定もありません。</div>
    )}
  </section>

  <style>
    .plainSection {
      padding: 0;
      margin: 0;
    }

    .sectionHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 8px;
    }

    .postList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .postRow {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px dotted var(--line);
      text-decoration: none;
      color: var(--ink);
    }

    .left {
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .right {
      display: flex;
      gap: 10px;
      align-items: baseline;
      font-size: 0.85em;
      color: var(--muted);
      white-space: nowrap;
    }

    .category {
      font-size: 0.85em;
      color: var(--muted);
    }

    .sep {
      color: var(--muted);
    }

    .tags {
      color: var(--muted);
    }

    .planMark {
      margin-left: 4px;
      font-weight: normal;
      font-size: 0.9em;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      .postRow {
        flex-direction: column;
        gap: 4px;
      }
      .right {
        white-space: normal;
      }
    }
  </style>
</BaseLayout>