---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

type Row = {
  href: string;
  title: string;
  summary: string;
  date: string;
  tags: string[];
  meta: string;
  typeLabel: string;
  sortKey: string;
};

function safeTags(tags: unknown): string[] {
  return Array.isArray(tags) ? tags.filter((t) => typeof t === "string") : [];
}

function isNotePost(data: { kind?: string }) {
  return data.kind === "note";
}

const postItems = await getCollection("posts", ({ data }) => !data.draft);
const translationItems = await getCollection("translation", ({ data }) => !data.draft);
const researchItems = await getCollection("research", ({ data }) => !data.draft);
const novelItems = await getCollection("novel", ({ data }) => !data.draft);

const rows: Row[] = [
  ...postItems.map((p) => ({
    href: `${BASE}posts/${p.slug}`,
    title: p.data.title,
    summary: p.data.summary ?? "",
    date: p.data.date,
    tags: safeTags(p.data.tags),
    meta: [p.data.category ?? "", p.data.series ?? ""].filter(Boolean).join(" "),
    typeLabel: isNotePost(p.data) ? "研究" : "記事",
    sortKey: `posts:${p.slug}`,
  })),
  ...translationItems.map((p) => ({
    href: `${BASE}study/${p.slug}`,
    title: p.data.title,
    summary: p.data.summary ?? "",
    date: p.data.date,
    tags: safeTags(p.data.tags),
    meta: [p.data.originalAuthor ?? "", p.data.sourceTitle ?? ""].filter(Boolean).join(" "),
    typeLabel: "翻訳",
    sortKey: `translation:${p.slug}`,
  })),
  ...researchItems.map((p) => ({
    href: `${BASE}study/${p.slug}`,
    title: p.data.title,
    summary: p.data.summary ?? "",
    date: p.data.date,
    tags: safeTags(p.data.tags),
    meta: [p.data.category ?? "", p.data.series ?? ""].filter(Boolean).join(" "),
    typeLabel: "研究",
    sortKey: `research:${p.slug}`,
  })),
  ...novelItems.map((p) => ({
    href: `${BASE}novel/${p.slug}`,
    title: p.data.title,
    summary: p.data.summary ?? "",
    date: p.data.date,
    tags: safeTags(p.data.tags),
    meta: "",
    typeLabel: "創作",
    sortKey: `novel:${p.slug}`,
  })),
].sort((a, b) => {
  if (a.date !== b.date) return a.date < b.date ? 1 : -1;
  return a.sortKey < b.sortKey ? 1 : -1;
});
---
<BaseLayout title="検索 | かもねぎ通信">
  <section class="searchPage">
    <header class="searchHead">
      <h2 class="h2" style="margin:0;">検索</h2>
      <p class="small count"><span id="count">{rows.length}</span> 件</p>
    </header>

    <div class="hr"></div>

    <p id="qHint" class="small qHint" hidden></p>

    <ul id="searchList" class="resultList">
      {rows.map((r) => (
        <li
          class="resultItem"
          data-title={r.title}
          data-summary={r.summary}
          data-tags={r.tags.join(" ")}
          data-meta={r.meta}
          data-type={r.typeLabel}
        >
          <a class="resultRow" href={r.href}>
            <span class="rowMain">
              <span class="rowTitle">{r.title}</span>
              {r.summary ? <span class="rowSummary">{r.summary}</span> : null}
            </span>
            <span class="rowMeta">
              <span class="rowType">{r.typeLabel}</span>
              {r.tags.length ? <span class="rowTags">#{r.tags.join(" #")}</span> : null}
            </span>
          </a>
        </li>
      ))}
    </ul>
  </section>

  <script is:inline>
    const list = document.getElementById("searchList");
    const qHint = document.getElementById("qHint");
    const count = document.getElementById("count");
    const q = (new URLSearchParams(window.location.search).get("q") || "").trim().toLowerCase();

    function hit(li, query) {
      const title = (li.dataset.title || "").toLowerCase();
      const summary = (li.dataset.summary || "").toLowerCase();
      const tags = (li.dataset.tags || "").toLowerCase();
      const meta = (li.dataset.meta || "").toLowerCase();
      const type = (li.dataset.type || "").toLowerCase();
      return !query || title.includes(query) || summary.includes(query) || tags.includes(query) || meta.includes(query) || type.includes(query);
    }

    const items = Array.from(list.querySelectorAll(".resultItem"));
    let visible = 0;
    for (const li of items) {
      const ok = hit(li, q);
      li.style.display = ok ? "" : "none";
      if (ok) visible += 1;
    }
    count.textContent = String(visible);

    if (qHint && q) {
      qHint.hidden = false;
      qHint.textContent = `検索: 「${q}」`;
    }
  </script>

  <style>
    .searchPage { width: min(100%, 940px); margin-inline: auto; display: grid; gap: 12px; }
    .searchHead { display: flex; justify-content: space-between; align-items: baseline; gap: 10px; flex-wrap: wrap; }
    .count { color: var(--muted); opacity: 0.82; }
    .qHint { margin: -6px 0 0; color: var(--muted); opacity: 0.82; }
    .resultList { list-style: none; padding: 0; margin: 0; display: grid; gap: 0; }
    .resultRow {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px dotted var(--line);
      text-decoration: none;
      color: var(--ink);
    }
    .resultRow:hover { opacity: 0.8; }
    .rowMain { min-width: 0; display: grid; gap: 2px; }
    .rowTitle { font-size: 0.98rem; line-height: 1.35; font-weight: 400; }
    .rowSummary { color: var(--muted); opacity: 0.78; font-size: 0.82rem; line-height: 1.45; }
    .rowMeta {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: flex-end;
      gap: 8px;
      color: var(--muted);
      font-size: 0.78rem;
    }
    .rowType { color: #4d5f42; font-weight: 600; white-space: nowrap; }
    .rowTags { opacity: 0.72; }
    @media (max-width: 640px) {
      .resultRow { flex-direction: column; gap: 4px; }
      .rowMeta { justify-content: flex-start; }
    }
  </style>
</BaseLayout>
