---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import ListIndexHeader from "../../components/ListIndexHeader.astro";

const BASE = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";

const posts = await getCollection("posts", ({ data }) => !data.draft);

const map = new Map<string, number>();
for (const p of posts) {
  const c = p.data.category?.trim();
  if (!c) continue;
  map.set(c, (map.get(c) ?? 0) + 1);
}

const categories = Array.from(map.entries())
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0], "ja"));
---

<BaseLayout title="カテゴリ | かもねぎ通信">
  <ListIndexHeader title="カテゴリ" countLabel={`${categories.length} categories`} />

  <div class="hr"></div>

  <ul class="catList">
    {categories.map(([c, n]) => (
      <li>
        <a class="catRow" href={`${BASE}category/${encodeURIComponent(c)}`}>
          <span class="catName">{c}</span>
          <span class="count">{n}</span>
        </a>
      </li>
    ))}
  </ul>
</BaseLayout>

<style>
  .catList { list-style:none; padding:0; margin:0; }
  .catRow {
    display:flex; justify-content:space-between; gap:12px;
    padding:8px 0; border-bottom:1px dotted var(--line);
    text-decoration:none; color:var(--ink);
  }
  .catRow:hover { opacity:0.75; }
  .catName { display:inline-flex; gap:6px; align-items:baseline; }
  .count { color: var(--muted); font-size:0.9em; }
</style>
